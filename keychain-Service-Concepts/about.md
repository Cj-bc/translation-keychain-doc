
# キーチェーンサービスのコンセプト

ユーザーは、通常、IDとパスワードを使用してログインするアカウントを複数管理します。セキュアなFTPサーバー、アップルシェアサーバー、データベースサーバー、セキュアなwebサイト、インスタントメッセージのアカウント、その他様々なサービスが認証を必要とします。
ユーザーは普通、シンプルで覚えやすいパスワードを使ったり、同じパスワードを何度も使ったり、簡単に見つけられるところにパスワードを書くことで対応します。どれも、セキュリティレベルを下げる行動です。

キーチェーンサービスAPIは、この問題に対して解決策を提示します。このAPIを一度呼び出すことで、アプリは小さな機密情報をキーチェーン上に、後にアプリが同じように一度の呼び出しで再取得できるようなところに、保管することができます。
キーチェーンは、データをファイルシステムに保存する前に暗号化することで、複雑な暗号化アルゴリズムを実行する手間を省きながら安全にデータを保管します。システムは又、保管された項目へのアクセスを慎重に制御します。キーチェーン全体をロックすることもできます。つまり、マスターパスワードを使って解除されるまでは、誰も保護された中身を復号化することはできないということです。ロックされていないキーチェーンだとしても、システムのキーチェーンアクセスポリシーが、認証されたアプリだけがキーチェーンに保存された項目にアクセスできることを保証します。一番簡単な例で言うと、項目を作成したアプリだけがその項目に後からアクセスすることができます。
しかしながら、キーチェーンサービスはアプリ間で機密を共有する方法も提供しています。

ユーザーの観点からすると、キーチェーンは透過的な（内部を意識する必要のない）認証を提供します。（キーチェーンをアンロックした後は）ユーザーはキーチェーンにパスワードガ保存されているサービスそれぞれにログインする必要がありません。認証されたアプリケーションは、ユーザーに確認をすることなくそれらを取得することができます。これにより、それらを覚えることや、安全ではない場所に記録する必要なく不規則で複雑、セキュリティ面からして価値のあるパスワードを使うことができます。
 [Figure 1-1](https://developer.apple.com/library/content/documentation/Security/Conceptual/keychainServConcepts/02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-CJBBFJHD)はユーザーとキーチェーン、そしてパスワードで保護されたサービスの関係図です。

(1-1 イメージ)
+-------------------------------------------------------+
|                                                       |
|ユーザーがキーチェーンをアンロックするパスワードを入力 |
|                                                       |
+-------------------------------------------------------+
          /     \
         /       \
        +----------+  +---------------------------------------------------+ 
        | keychain |  | 信頼されたアプリケーションは、keychainに保存された|
        +----------+  | パスワードやその他機密にアクセスできます。        |
           ||=======> +---------------------------------------------------+

パスワードに加えて、暗号鍵や証明書、macOSならさらに文字列も保存できます。鍵や証明書の作り方および管理などに関する詳しい情報は、[Certificate, Key, and Trust Services(外部リンク)](https://developer.apple.com/documentation/security/certificate_key_and_trust_services)を参照してください。


# キーチェーンの構造

一定の状況下では、キーチェーンは単純にファイルシステムに格納されているデータベースです。
デフォルトでは、macOSでは、それぞれのログインアカウントは一つずつキーチェーンを持っています。(macOS 10.3以降における新規アカウントに対しては、このキーチェーンは`login.keychain`と名付けられています)。ですが、ユーザーやアプリケーションは望む分だけキーチェーンを作成することができます。
それに対して、iOSにはすべてのアプリから利用可能な一つのキーチェーンがあります。又、ユーザーが端末からiCloudにログインした際、システムは論理的に異なったiCloudキーチェーンを提供します。

キーチェーンはいくつもの、データと属性から構成されるキーチェーン項目を保持しています。属性は、項目のクラスによってキーチェーンの項目と結びついています。作成日時やラベル
などのいくつかの属性は、すべての項目のクラスに共通しています。他は、クラス固有の属性になります。例えば、「ジェネラルパスワード」クラスは、サービスとアカウント名の属性を含んでいます。
一方で「インターネットパスワード項目」クラスは、サーバー名、セキュリティドメイン、プロトコルタイプやパスといったものを、アカウント名と同じように属性として含んでいます。

`KSecAttrSynchronizable`属性を用いて同期可能と示された項目は、iCloudキーチェーンに置かれ、ネットワークを通じて同じiCloudアカウントにログインしている全ての端末のiCloudキーチェーンに同期されます。

パスワードや秘密鍵(非対称暗号で使われる短い機密文字列)のように保護が必要な項目については、暗号化されキーチェーンによって保護されています。証明書のような保護の必要のない項目については暗号化されていません。暗号化されたデータは、キーチェーンがロックされているときアクセス不可能になります。
macOSで、キーチェーンがロックされている間に暗号化されたデータにアクセスしようとした場合、キーチェーンサービスは、キーチェーンパスワードを要求するダイアログを表示します。
iOSでは、デバイスのロックが解除された時にキーチェーンのロックも自動的に解除されるため、またロックされるまでの間はアプリケーションはいつでもそれぞれの持つキーチェーン項目にアクセスすることができます。

 --------------------------------------
*注意*: データとは異なり、項目の属性は機密とは考えられていないので暗号化されません。例えキーチェーンがロックされていたとしても、いつでも参照が可能です。
 --------------------------------------

macOSでは、iCloudで同期されていない項目は、保護されている各項目（とキーチェーン自身）はアクセス制御情報を追加で持っています。それらは「アクセスオブジェクト」と呼ばれるオパキューデータ構造をとります。
アクセスオブジェクトは、その項目についての糸つまたはそれ以上のアクセスコントロールリスト(ACL)エントリーを格納しています。各ACLエントリーは、その項目に対して行うことができる処理(復号化や認証のような)を特定する認証タグを一つまたは複数保持するリストを持っています。
それに加え各ACLエントリーは、ユーザーからの認証なしに指定された処理をおこなうことのできる信頼されたアプリケーションのリストも持っています。
ACLについて詳しくは、[Access Control Lists](https://github.com/Cj-bc/translation-keychain-doc/blob/master/keychain-Services-Concepts/about.md#L           )を参照してください。
**link未完成** **tagもね**


